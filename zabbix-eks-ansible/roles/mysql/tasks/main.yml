---
- name: Create MySQL secret (credentials)
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig_path }}"
    context: "{{ kube_context | default(omit) }}"
    namespace: "{{ zabbix_namespace }}"
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: mysql-secret
      type: Opaque
      stringData:
        MYSQL_ROOT_PASSWORD: "{{ db_root_password }}"
        MYSQL_PASSWORD: "{{ db_zabbix_password }}"
        MYSQL_USER: "{{ db_user }}"
        MYSQL_DATABASE: "{{ db_name }}"

- name: Render MySQL StatefulSet manifest from template
  ansible.builtin.template:
    src: mysql-statefulset.yaml.j2
    dest: "/tmp/mysql-statefulset.yaml"

- name: Deploy MySQL StatefulSet + Service
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig_path }}"
    context: "{{ kube_context | default(omit) }}"
    namespace: "{{ zabbix_namespace }}"
    state: present
    src: "/tmp/mysql-statefulset.yaml"

- name: Deploy HAProxy for MySQL (ClusterIP)
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig_path }}"
    context: "{{ kube_context | default(omit) }}"
    namespace: "{{ zabbix_namespace }}"
    state: present
    src: "{{ role_path }}/files/mysql-haproxy.yaml"
